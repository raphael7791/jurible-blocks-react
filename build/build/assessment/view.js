(()=>{function s(r){if("true"===r.dataset.initialized)return;r.dataset.initialized="true";const o=r.dataset.assessmentId;r.dataset.assessmentTitle,o?(r.innerHTML='<div class="assess-loading"><span class="assess-spinner"></span> Chargement...</div>',fetch(`/wp-json/jurible/v1/assessments/${o}/my-submission`,{credentials:"same-origin",headers:{"X-WP-Nonce":n()}}).then(s=>s.json()).then(o=>{o.success?function(r,o){const{assessment:l,submission:c}=o;let d='<div class="assess-block">';d+='<div class="assess-block-header"><span class="assess-block-icon">ğŸ“¤</span> RENDRE VOTRE TRAVAIL</div>',d+='<div class="assess-block-content">',c?"submitted"===c.status?d+=function(s,n){let i=`\n        <div class="assess-status assess-status-submitted">\n            <span class="assess-status-icon">âœ…</span>\n            <span>Soumis</span>\n        </div>\n        <div class="assess-submission-info">\n            <p><strong>ğŸ“„ ${a(s.file_url)}</strong></p>\n            <p>Soumis le ${t(new Date(s.submitted_at))}</p>\n        </div>\n    `;return i+=e(n),i+='\n        <div class="assess-waiting">\n            <p>â³ En attente de correction</p>\n            <p class="assess-waiting-hint">Vous serez notifiÃ© par email dÃ¨s que votre travail sera corrigÃ©.</p>\n        </div>\n    ',i}(c,l):"in_review"===c.status?d+=function(s,n){let i=`\n        <div class="assess-status assess-status-review">\n            <span class="assess-status-icon">ğŸ”µ</span>\n            <span>En cours de correction</span>\n        </div>\n        <div class="assess-submission-info">\n            <p><strong>ğŸ“„ ${a(s.file_url)}</strong></p>\n            <p>Soumis le ${t(new Date(s.submitted_at))}</p>\n        </div>\n    `;return i+=e(n),i+='\n        <div class="assess-waiting">\n            <p>ğŸ” Votre professeur corrige actuellement votre travail...</p>\n        </div>\n    ',i}(c,l):"graded"===c.status&&(d+=function(s,n){const t=s.score/n.max_score*100;let r="score-low";t>=70?r="score-high":t>=50&&(r="score-medium");let o=`\n        <div class="assess-status assess-status-graded">\n            <span class="assess-status-icon">âœ…</span>\n            <span>CorrigÃ©</span>\n        </div>\n        <div class="assess-score ${r}">\n            <span class="assess-score-value">${s.score}</span>\n            <span class="assess-score-max">/ ${n.max_score}</span>\n        </div>\n        <div class="assess-feedback">\n            <div class="assess-feedback-header">ğŸ’¬ Feedback de votre professeur</div>\n            <div class="assess-feedback-content">${i(s.feedback)}</div>\n        </div>\n    `;if(s.video_url){const e=s.video_url.match(/tella\.tv\/video\/([a-zA-Z0-9-]+)/);o+=e?`\n                <div class="assess-video-embed">\n                    <div class="assess-video-header">ğŸ¥ VidÃ©o de correction</div>\n                    <div class="assess-video-container">\n                        <iframe \n                            src="https://www.tella.tv/video/${e[1]}/embed?b=1&title=1&a=1&loop=0&t=0&muted=0&wt=1" \n                            allowfullscreen \n                            allowtransparency>\n                        </iframe>\n                    </div>\n                </div>\n            `:`\n                <div class="assess-video">\n                    <a href="${i(s.video_url)}" target="_blank" class="assess-video-btn">\n                        ğŸ¥ Voir la vidÃ©o de correction\n                    </a>\n                </div>\n            `}return n.correction_pdf_url&&(o+=`\n            <div class="assess-correction-pdf">\n                <a href="${i(n.correction_pdf_url)}" target="_blank" class="assess-correction-btn">\n                    ğŸ“ TÃ©lÃ©charger la correction type (PDF)\n                </a>\n            </div>\n        `),o+=e(n),o+=`\n        <div class="assess-submission-file">\n            <p>ğŸ“„ Votre copie : <a href="${i(s.file_url)}" target="_blank">${a(s.file_url)}</a></p>\n        </div>\n    `,o}(c,l)):d+=function(s){let n='\n        <div class="assess-status assess-status-pending">\n            <span class="assess-status-icon">â³</span>\n            <span>Non rendu</span>\n        </div>\n    ';if(s.due_date){const e=new Date(s.due_date),a=e<new Date;n+=`\n            <div class="assess-due-date ${a?"overdue":""}">\n                ğŸ“… Date limite : ${t(e)}\n                ${a?'<span class="overdue-badge">En retard</span>':""}\n            </div>\n        `}return n+=e(s),n+='\n        <div class="assess-upload-zone" id="assess-upload-zone">\n            <div class="assess-upload-icon">ğŸ“„</div>\n            <p>Glissez votre fichier ici ou</p>\n            <label class="assess-upload-btn">\n                <input type="file" id="assess-file-input" accept=".pdf,.docx,.doc,.odt" style="display:none;">\n                Choisir un fichier\n            </label>\n            <p class="assess-upload-hint">Formats acceptÃ©s : PDF, DOCX, ODT â€¢ Max 20 MB</p>\n        </div>\n        <div class="assess-file-preview" id="assess-file-preview" style="display:none;">\n            <span class="assess-file-icon">ğŸ“„</span>\n            <span class="assess-file-name" id="assess-file-name"></span>\n            <button type="button" class="assess-file-remove" id="assess-file-remove">âœ•</button>\n        </div>\n        <button type="button" class="assess-submit-btn" id="assess-submit-btn" disabled>\n            Soumettre mon travail\n        </button>\n    ',n}(l),d+="</div></div>",r.innerHTML=d,function(e,t){const a=e.querySelector("#assess-file-input"),i=e.querySelector("#assess-upload-zone"),r=e.querySelector("#assess-file-preview"),o=e.querySelector("#assess-file-name"),l=e.querySelector("#assess-file-remove"),c=e.querySelector("#assess-submit-btn");if(!a)return;let d=null;function u(s){s.size>20971520?alert("Le fichier est trop volumineux. Taille maximum : 20 MB"):["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword","application/vnd.oasis.opendocument.text"].includes(s.type)||s.name.match(/\.(pdf|docx?|odt)$/i)?(o.textContent=s.name,r.style.display="flex",i.style.display="none",c.disabled=!1):alert("Format de fichier non acceptÃ©. Utilisez PDF, DOCX ou ODT.")}a.addEventListener("change",function(){this.files&&this.files[0]&&(d=this.files[0],u(d))}),i&&(i.addEventListener("dragover",function(s){s.preventDefault(),this.classList.add("dragover")}),i.addEventListener("dragleave",function(s){s.preventDefault(),this.classList.remove("dragover")}),i.addEventListener("drop",function(s){s.preventDefault(),this.classList.remove("dragover"),s.dataTransfer.files&&s.dataTransfer.files[0]&&(d=s.dataTransfer.files[0],u(d))})),l&&l.addEventListener("click",function(){d=null,a.value="",r.style.display="none",i.style.display="block",c.disabled=!0}),c&&c.addEventListener("click",function(){d&&function(e,t,a,i){i.disabled=!0,i.innerHTML='<span class="assess-spinner"></span> Envoi en cours...';const r=new FormData;r.append("file",a),fetch(`/wp-json/jurible/v1/assessments/${t}/submit`,{method:"POST",credentials:"same-origin",headers:{"X-WP-Nonce":n()},body:r}).then(s=>s.json()).then(n=>{n.success?(e.dataset.initialized="false",s(e)):(alert(n.message||"Erreur lors de la soumission"),i.disabled=!1,i.textContent="Soumettre mon travail")}).catch(s=>{console.error("Erreur:",s),alert("Erreur de connexion. Veuillez rÃ©essayer."),i.disabled=!1,i.textContent="Soumettre mon travail"})}(e,t.id,d,c)})}(r,l)}(r,o.data):r.innerHTML=`<p style="color: #EF4444;">${o.message||"Erreur de chargement"}</p>`}).catch(s=>{console.error("Erreur:",s),r.innerHTML='<p style="color: #EF4444;">Erreur de connexion. Veuillez rafraÃ®chir la page.</p>'})):r.innerHTML='<p style="color: #EF4444;">Assessment non configurÃ©.</p>'}function e(s){return s.subject_pdf_url?`\n        <div class="assess-subject-pdf">\n            <a href="${i(s.subject_pdf_url)}" target="_blank" class="assess-subject-btn">\n                ğŸ“‹ TÃ©lÃ©charger le sujet (PDF)\n            </a>\n        </div>\n    `:""}function n(){if("undefined"!=typeof wpApiSettings&&wpApiSettings.nonce)return wpApiSettings.nonce;if("undefined"!=typeof juribleAssess&&juribleAssess.nonce)return juribleAssess.nonce;const s=document.querySelector('meta[name="wp-nonce"]');return s?s.content:""}function t(s){return s.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}function a(s){return s?s.split("/").pop().split("?")[0]:"Fichier"}function i(s){if(!s)return"";const e=document.createElement("div");return e.textContent=s,e.innerHTML}function r(){document.querySelectorAll(".jurible-assessment-container").forEach(s)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r(),new MutationObserver(function(e){e.forEach(function(e){e.addedNodes.forEach(function(e){1===e.nodeType&&(e.classList&&e.classList.contains("jurible-assessment-container")&&s(e),e.querySelectorAll&&e.querySelectorAll(".jurible-assessment-container").forEach(s))})})}).observe(document.body,{childList:!0,subtree:!0})})();