!function(){"use strict";const e="https://iframe.mediadelivery.net/embed/35843/",n="/wp-json/jurible-playlist/v1/progress";let t=null,i=null,l=!0,o=[],s=0,r={},a=0;function c(){document.querySelectorAll(".jurible-playlist-container:not([data-initialized])").forEach(a=>{a.setAttribute("data-initialized","true"),async function(a){const c=a.dataset.collectionId;if(a.dataset.collectionName,c){i=c,a.innerHTML='<div class="jurible-playlist-loading"><div class="jurible-spinner"></div>Chargement...</div>';try{const v=await fetch(`/wp-json/jurible/v1/bunny/collections/${c}/videos`),b=await v.json();if(!b.success||!b.videos||0===b.videos.length)return void(a.innerHTML='<div class="jurible-playlist-error">Aucune vidéo trouvée</div>');o=b.videos,s=0,t=o[0].id,await async function(e){try{const t=await fetch(`${n}/${e}`,{credentials:"same-origin"});if(t.ok){const e=await t.json();e.success&&e.progress&&(r=e.progress)}}catch(e){console.log("Could not load progress (user may not be logged in)")}}(c),function(n){const t=o[0],a=y(),c=o.length>0?a/o.length*100:0;n.innerHTML=`\n            <div class="jurible-playlist" data-collection="${i}">\n                \x3c!-- Player --\x3e\n                <div class="jurible-player-container">\n                    <div class="jurible-player-wrapper">\n                        <iframe\n                            id="jurible-player-${i}"\n                            src="${e}${t.id}?autoplay=false&preload=true"\n                            style="position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;border:none!important;"\n                            allow="accelerometer;gyroscope;autoplay;encrypted-media;picture-in-picture"\n                            allowfullscreen\n                        ></iframe>\n                    </div>\n                    <div class="jurible-player-info">\n                        <h3 class="jurible-current-title">${t.title}</h3>\n                    </div>\n                </div>\n\n                \x3c!-- Controls --\x3e\n                <div class="jurible-playlist-controls">\n                    <div class="jurible-playlist-header">\n                        <span class="jurible-video-count">${o.length} vidéos</span>\n                        <span class="jurible-progress-count">\n                            <span class="jurible-completed-count">${a}</span>/${o.length} terminées\n                        </span>\n                    </div>\n                    <label class="jurible-autoplay-toggle">\n                        <input type="checkbox" id="jurible-autoplay-${i}" ${l?"checked":""}>\n                        <span class="jurible-toggle-slider"></span>\n                        <span class="jurible-toggle-label">Lecture auto</span>\n                    </label>\n                </div>\n\n                \x3c!-- Progress Bar --\x3e\n                <div class="jurible-collection-progress">\n                    <div class="jurible-progress-bar">\n                        <div class="jurible-progress-fill" style="width: ${c}%"></div>\n                    </div>\n                </div>\n\n                \x3c!-- Video List --\x3e\n                <div class="jurible-video-list">\n                    ${o.map((e,n)=>function(e,n){const t=n===s,i=r[e.id]?.completed;return`\n            <div class="jurible-video-item ${t?"active":""} ${i?"completed":""}"\n                 data-video-id="${e.id}"\n                 data-index="${n}">\n                <div class="jurible-video-number">${n+1}</div>\n                <div class="jurible-video-thumbnail">\n                    ${e.thumbnail?`<img src="${e.thumbnail}" alt="${e.title}" loading="lazy"\n                              onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">\n                         <div class="jurible-thumbnail-placeholder" style="display:none;">\n                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <polygon points="5 3 19 12 5 21 5 3"></polygon>\n                            </svg>\n                         </div>`:'<div class="jurible-thumbnail-placeholder">\n                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <polygon points="5 3 19 12 5 21 5 3"></polygon>\n                            </svg>\n                         </div>'}\n                    ${t?'<div class="jurible-now-playing"><span></span><span></span><span></span></div>':""}\n                </div>\n                <div class="jurible-video-info">\n                    <span class="jurible-video-title">${e.title}</span>\n                    <span class="jurible-video-duration">${e.durationFormatted}</span>\n                </div>\n                ${i?'\n                    <div class="jurible-video-completed">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">\n                            <polyline points="20 6 9 17 4 12"></polyline>\n                        </svg>\n                    </div>\n                ':""}\n            </div>\n        `}(e,n)).join("")}\n                </div>\n            </div>\n        `}(a),function(e){e.querySelectorAll(".jurible-video-item").forEach(n=>{n.addEventListener("click",()=>{const t=n.dataset.videoId,i=parseInt(n.dataset.index,10);d(e,t,i)})});const n=e.querySelector(`#jurible-autoplay-${i}`);n&&n.addEventListener("change",e=>{l=e.target.checked})}(a),window.addEventListener("message",e=>{if(e.origin.includes("mediadelivery.net")||e.origin.includes("bunnycdn"))try{let n=e.data;"string"==typeof n&&(n=JSON.parse(n)),function(e){if("videoProgress"!==e.event&&"progress"!==e.type||(e.percent||e.progress||0)>=.9&&p(t),("videoEnded"===e.event||"ended"===e.type)&&(p(t),l)){const e=document.querySelector(`.jurible-playlist[data-collection="${i}"]`);e&&setTimeout(()=>function(e){if(s<o.length-1){const n=s+1;d(e,o[n].id,n)}}(e.parentElement),1e3)}"videoPlay"!==e.event&&"play"!==e.type||u(t)}(n)}catch(e){}})}catch(e){console.error("Error loading playlist:",e),a.innerHTML='<div class="jurible-playlist-error">Erreur de chargement</div>'}}else a.innerHTML='<div class="jurible-playlist-error">Collection non configurée</div>'}(a)})}function d(n,i,l){const r=o[l];if(!r)return;t=i,s=l,a=Date.now();const c=n.querySelector("iframe");c&&(c.src=`${e}${i}?autoplay=true&preload=true`);const d=n.querySelector(".jurible-current-title");d&&(d.textContent=r.title),n.querySelectorAll(".jurible-video-item").forEach((e,n)=>{e.classList.toggle("active",n===l);const t=e.querySelector(".jurible-now-playing");if(t&&t.remove(),n===l){const n=e.querySelector(".jurible-video-thumbnail");n&&n.insertAdjacentHTML("beforeend",'<div class="jurible-now-playing"><span></span><span></span><span></span></div>')}}),u(i);const p=n.querySelector(".jurible-video-item.active");p&&p.scrollIntoView({behavior:"smooth",block:"nearest"})}function u(e){r[e]||v(e,"started",0)}function p(e){r[e]?.completed||(v(e,"completed",Math.floor((Date.now()-a)/1e3)),r[e]={status:"completed",completed:!0},function(){const e=y(),n=o.length>0?e/o.length*100:0;document.querySelectorAll(".jurible-completed-count").forEach(n=>{n.textContent=e}),document.querySelectorAll(".jurible-progress-fill").forEach(e=>{e.style.width=n+"%"}),document.querySelectorAll(".jurible-video-item").forEach(e=>{const n=e.dataset.videoId;r[n]?.completed&&(e.classList.add("completed"),e.querySelector(".jurible-video-completed")||e.insertAdjacentHTML("beforeend",'\n                        <div class="jurible-video-completed">\n                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">\n                                <polyline points="20 6 9 17 4 12"></polyline>\n                            </svg>\n                        </div>\n                    '))})}())}async function v(e,t,l){try{await fetch(n,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.wpApiSettings?.nonce||""},body:JSON.stringify({video_id:e,collection_id:i,status:t,watch_time:l})})}catch(e){console.log("Could not save progress")}}function y(){return Object.values(r).filter(e=>e.completed||"completed"===e.status).length}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c):c(),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length&&c()})}).observe(document.body,{childList:!0,subtree:!0})}();